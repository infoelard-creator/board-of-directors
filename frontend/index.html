<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board.AI ‚Äî –°–æ–≤–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤ –Ω–∞ GigaChat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            height: 85vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .agents-section h3 {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #666;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .agent-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 200ms;
            background: white;
            border: 1px solid #e9ecef;
        }

        .agent-item:hover {
            background: #f0f2f5;
            border-color: #dee2e6;
        }

        .agent-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .agent-item input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .agent-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .agent-name {
            font-size: 13px;
            font-weight: 500;
            flex: 1;
        }

        .debug-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 8px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            cursor: pointer;
        }

        .debug-toggle input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .debug-toggle label {
            font-size: 13px;
            cursor: pointer;
            flex: 1;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #ffffff;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #999;
            text-align: center;
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #667eea;
        }

        .empty-state p {
            font-size: 14px;
            max-width: 300px;
            line-height: 1.5;
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            line-height: 1.5;
            font-size: 14px;
        }

        .message.user {
            background: #e7f3ff;
            color: #0c5aa0;
            margin-left: 40px;
            text-align: left;
        }

        .message.agent {
            background: #f5f5f5;
            color: #333;
            margin-right: 40px;
            border-left: 4px solid #667eea;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 8px;
            color: #667eea;
        }

        .agent-icon {
            font-size: 16px;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .content-section {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .section-label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #667eea;
            min-width: 100px;
            padding-top: 2px;
        }

        .section-value {
            flex: 1;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.go {
            background: #d4edda;
            color: #155724;
        }

        .badge.no-go {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.fast {
            background: #d4edda;
            color: #155724;
        }

        .badge.slow {
            background: #fff3cd;
            color: #856404;
        }

        .badge.safe {
            background: #d4edda;
            color: #155724;
        }

        .badge.vulnerable {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.scalable {
            background: #d4edda;
            color: #155724;
        }

        .badge.manual {
            background: #fff3cd;
            color: #856404;
        }

        .badge.fixable {
            background: #fff3cd;
            color: #856404;
        }

        .badge.fatal {
            background: #f8d7da;
            color: #721c24;
        }

        .confidence-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            display: flex;           /* ‚Üê –î–û–ë–ê–í–ò–¢–¨ */ 
            align-items: center;     /* ‚Üê –î–û–ë–ê–í–ò–¢–¨ */
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 600ms ease-out;
        }

        .confidence-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            z-index: 10;              
            pointer-events: none;     
        }

        .input-area {
            padding: 16px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            display: flex;
            gap: 8px;
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
        }

        #messageInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        #sendBtn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 200ms;
        }

        #sendBtn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        #sendBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        #summaryBtn {
            padding: 12px 24px;
            background: #764ba2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: none;
            transition: all 200ms;
        }

        #summaryBtn:hover:not(:disabled) {
            background: #653a85;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
        }

        #summaryBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .skeleton {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .skeleton-line {
            height: 12px;
            background: linear-gradient(90deg, #e9ecef 25%, #f0f2f5 50%, #e9ecef 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ===== DEBUG PANEL ===== */
        .debug-panel {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            font-size: 12px;
            font-family: 'Monaco', 'Courier New', monospace;
            display: none;
        }

        .debug-panel.visible {
            display: block;
        }

        .debug-panel-title {
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .debug-row {
            display: flex;
            gap: 12px;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
        }

        .debug-row:last-child {
            border-bottom: none;
        }

        .debug-label {
            font-weight: 600;
            color: #666;
            min-width: 120px;
        }

        .debug-value {
            color: #333;
            word-break: break-all;
            flex: 1;
        }

        .debug-value.metric {
            color: #208090;
            font-weight: 600;
        }

        .debug-tokens {
            display: flex;
            gap: 16px;
        }

        .debug-token-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .debug-token-label {
            font-size: 10px;
            text-transform: uppercase;
            color: #999;
        }

        .debug-token-value {
            font-size: 13px;
            font-weight: 600;
            color: #208090;
        }

        .debug-json {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
            max-height: 200px;
            overflow: auto;
            word-break: break-all;
            font-size: 11px;
        }

        .debug-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }

        .debug-tab {
            padding: 6px 12px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            transition: all 200ms;
        }

        .debug-tab:hover {
            color: #208090;
        }

        .debug-tab.active {
            color: #208090;
            border-bottom-color: #208090;
        }

        .debug-content {
            display: none;
        }

        .debug-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="agents-section">
                <h3>–ß–ª–µ–Ω—ã —Å–æ–≤–µ—Ç–∞</h3>
                <div id="agentsList"></div>
            </div>

            <div class="debug-toggle">
                <input type="checkbox" id="debugCheckbox">
                <label for="debugCheckbox">üîß Debug —Ä–µ–∂–∏–º</label>
            </div>

            <div>
                <button id="summaryBtn">üìä –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–∏</button>
            </div>
        </div>

        <!-- Main Chat -->
        <div class="main">
            <div class="chat-area" id="chatArea">
                <div class="empty-state">
                    <h2>üéØ Board.AI</h2>
                    <p>–ú–Ω–æ–≥–æ–∞–≥–µ–Ω—Ç–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–¥–µ–π –∏ –±–∏–∑–Ω–µ—Å-—Ä–µ—à–µ–Ω–∏–π –Ω–∞ –±–∞–∑–µ GigaChat</p>
                </div>
            </div>

            <div class="input-area">
                <textarea id="messageInput" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∏–¥–µ—é –∏–ª–∏ –≤–æ–ø—Ä–æ—Å..."></textarea>
                <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====

        let authToken = null;
        let selectedAgents = new Set();
        let chatHistory = [];
        let isLoading = false;
        let hasSummary = false;
        let lastRoundAgents = [];

        const agents = {
            "ceo": { name: "CEO", icon: "üëî", color: "#667eea" },
            "cfo": { name: "CFO", icon: "üí∞", color: "#764ba2" },
            "cpo": { name: "CPO", icon: "üéØ", color: "#f093fb" },
            "marketing": { name: "Marketing", icon: "üì¢", color: "#4facfe" },
            "skeptic": { name: "Skeptic", icon: "‚ö†Ô∏è", color: "#fa709a" },
            "summary": { name: "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä", icon: "üìä", color: "#30b0c0" },
        };

        const chatArea = document.getElementById("chatArea");
        const messageInput = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");
        const summaryBtn = document.getElementById("summaryBtn");
        const debugCheckbox = document.getElementById("debugCheckbox");
        const agentsList = document.getElementById("agentsList");

        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====

        function init() {
            renderAgentsList();
            setupEventListeners();
            authenticateUser();
        }

        function renderAgentsList() {
            const agentKeys = ["ceo", "cfo", "cpo", "marketing", "skeptic"];
            agentsList.innerHTML = agentKeys.map(key => `
                <div class="agent-item active" data-agent="${key}">
                    <input type="checkbox" checked data-agent="${key}">
                    <span class="agent-icon">${agents[key].icon}</span>
                    <span class="agent-name">${agents[key].name}</span>
                </div>
            `).join("");

            selectedAgents = new Set(agentKeys);

            document.querySelectorAll(".agent-item input").forEach(checkbox => {
                checkbox.addEventListener("change", (e) => {
                    const agent = e.target.dataset.agent;
                    if (e.target.checked) {
                        selectedAgents.add(agent);
                        e.target.closest(".agent-item").classList.add("active");
                    } else {
                        selectedAgents.delete(agent);
                        e.target.closest(".agent-item").classList.remove("active");
                    }
                });
            });
        }

        function setupEventListeners() {
            messageInput.addEventListener("input", (e) => {
                e.target.style.height = "auto";
                e.target.style.height = Math.min(e.target.scrollHeight, 100) + "px";
                sendBtn.disabled = !e.target.value.trim();
            });

            messageInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendBtn.addEventListener("click", sendMessage);

            summaryBtn.addEventListener("click", async () => {
                if (!hasSummary || isLoading) return;

                try {
                    isLoading = true;
                    sendBtn.disabled = true;
                    summaryBtn.disabled = true;

                    const url = "/api/summary";

                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${authToken}`,
                        },
                        body: JSON.stringify({
                            history: chatHistory.slice(-20),
                            debug: !!debugCheckbox.checked
                        })
                    });

                    if (!response.ok) {
                        const txt = await response.text().catch(() => "");
                        console.error("Summary error:", response.status, response.statusText, txt);

                        if (response.status === 429) {
                            addMessage('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∏—Ç–æ–≥–∞–º. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'agent', 'summary');
                        } else {
                            addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'agent', 'summary');
                        }
                        return;
                    }

                    const data = await response.json();
                    addMessage(data.text, 'agent', 'summary', data);

                } catch (err) {
                    console.error("Request failed:", err);
                    addMessage('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ –∏—Ç–æ–≥–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'agent', 'summary');
                } finally {
                    isLoading = false;
                    sendBtn.disabled = !messageInput.value.trim();
                    summaryBtn.disabled = false;
                }
            });
        }

        // ===== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø =====

        function authenticateUser() {
            const existingToken = localStorage.getItem("authToken");
            const existingUserId = localStorage.getItem("userId");

            if (existingToken && existingUserId) {
                authToken = existingToken;
                return;
            }

            const userId = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID (–ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, _ –∏–ª–∏ -):", "user_" + Math.random().toString(36).substr(2, 9));

            if (!userId) {
                alert("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ ID –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.");
                authenticateUser();
                return;
            }

            loginUser(userId);
        }

        async function loginUser(userId) {
            try {
                const response = await fetch("/api/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                authToken = data.access_token;

                localStorage.setItem("authToken", authToken);
                localStorage.setItem("userId", userId);
            } catch (err) {
                console.error("Login failed:", err);
                alert("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
                authenticateUser();
            }
        }

        // ===== DEBUG HELPER FUNCTIONS =====

        function formatJson(obj) {
            try {
                return JSON.stringify(obj, null, 2);
            } catch (e) {
                return String(obj);
            }
        }

        function createDebugPanel(debugData) {
            const panel = document.createElement('div');
            panel.className = 'debug-panel visible';

            const title = document.createElement('div');
            title.className = 'debug-panel-title';
            title.textContent = '‚öôÔ∏è Debug Info';
            panel.appendChild(title);

            const tabs = document.createElement('div');
            tabs.className = 'debug-tabs';

            const metricsTab = document.createElement('button');
            metricsTab.className = 'debug-tab active';
            metricsTab.textContent = 'Metrics';
            metricsTab.addEventListener('click', () => switchDebugTab(panel, 'metrics'));

            const inputTab = document.createElement('button');
            inputTab.className = 'debug-tab';
            inputTab.textContent = 'Input';
            inputTab.addEventListener('click', () => switchDebugTab(panel, 'input'));

            const outputTab = document.createElement('button');
            outputTab.className = 'debug-tab';
            outputTab.textContent = 'Output';
            outputTab.addEventListener('click', () => switchDebugTab(panel, 'output'));

            tabs.appendChild(metricsTab);
            tabs.appendChild(inputTab);
            tabs.appendChild(outputTab);
            panel.appendChild(tabs);

            const metricsContent = document.createElement('div');
            metricsContent.className = 'debug-content active';

            const metricsHTML = `
                <div class="debug-row">
                    <div class="debug-label">Model:</div>
                    <div class="debug-value">${debugData.meta?.model || 'N/A'}</div>
                </div>
                <div class="debug-row">
                    <div class="debug-label">Latency:</div>
                    <div class="debug-value metric">${debugData.meta?.latency_ms?.toFixed(0) || '‚Äî'} ms</div>
                </div>
                <div class="debug-row">
                    <div class="debug-label">Tokens:</div>
                    <div class="debug-value">
                        <div class="debug-tokens">
                            <div class="debug-token-item">
                                <div class="debug-token-label">Input</div>
                                <div class="debug-token-value">${debugData.meta?.tokens_input || 0}</div>
                            </div>
                            <div class="debug-token-item">
                                <div class="debug-token-label">Output</div>
                                <div class="debug-token-value">${debugData.meta?.tokens_output || 0}</div>
                            </div>
                            <div class="debug-token-item">
                                <div class="debug-token-label">Total</div>
                                <div class="debug-token-value" style="color: #c23131;">${debugData.meta?.tokens_total || 0}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="debug-row">
                    <div class="debug-label">Finish Reason:</div>
                    <div class="debug-value">${debugData.meta?.finish_reason || 'unknown'}</div>
                </div>
                <div class="debug-row">
                    <div class="debug-label">Timestamp:</div>
                    <div class="debug-value">${debugData.meta?.timestamp || '‚Äî'}</div>
                </div>
            `;
            metricsContent.innerHTML = metricsHTML;
            panel.appendChild(metricsContent);

            const inputContent = document.createElement('div');
            inputContent.className = 'debug-content';
            if (debugData.meta?.compressed_input) {
                const jsonDiv = document.createElement('div');
                jsonDiv.className = 'debug-json';
                jsonDiv.textContent = formatJson(debugData.meta.compressed_input);
                inputContent.appendChild(jsonDiv);
            } else {
                inputContent.textContent = 'No input data';
            }
            panel.appendChild(inputContent);

            const outputContent = document.createElement('div');
            outputContent.className = 'debug-content';
            if (debugData.meta?.compressed_output) {
                const jsonDiv = document.createElement('div');
                jsonDiv.className = 'debug-json';
                jsonDiv.textContent = formatJson(debugData.meta.compressed_output);
                outputContent.appendChild(jsonDiv);
            } else if (debugData.compressed) {
                const jsonDiv = document.createElement('div');
                jsonDiv.className = 'debug-json';
                jsonDiv.textContent = formatJson(debugData.compressed);
                outputContent.appendChild(jsonDiv);
            } else {
                outputContent.textContent = 'No output data';
            }
            panel.appendChild(outputContent);

            return panel;
        }

        function switchDebugTab(panel, tabName) {
            panel.querySelectorAll('.debug-tab').forEach(tab => tab.classList.remove('active'));
            panel.querySelectorAll('.debug-content').forEach(content => content.classList.remove('active'));

            const tabMap = {
                'metrics': 0,
                'input': 1,
                'output': 2,
            };

            if (tabMap[tabName] !== undefined) {
                panel.querySelectorAll('.debug-tab')[tabMap[tabName]].classList.add('active');
                panel.querySelectorAll('.debug-content')[tabMap[tabName]].classList.add('active');
            }
        }

        // ===== –ü–ê–†–°–ò–ù–ì –û–¢–í–ï–¢–û–í =====

        function parseAgentResponse(text, agentType) {
            const lines = text.split('\n').filter(l => l.trim());
            const sections = [];

            lines.forEach(line => {
                const match = line.match(/^\[([^\]]+)\]\s*‚Äî\s*(.+)$/);
                if (!match) {
                    return;
                }

                const label = match[1].trim();
                const value = match[2].trim();

                let type = 'text';
                let badgeType = null;

                if (label.toLowerCase().includes('verdict') || label.toLowerCase().includes('confidence')) {
                    const upperVal = value.toUpperCase();
                    if (upperVal === 'GO' || upperVal === 'FAST' || upperVal === 'SAFE' || upperVal === 'SCALABLE' || upperVal === 'FIXABLE') {
                        type = 'badge';
                        badgeType = upperVal.toLowerCase();
                    } else if (upperVal === 'NO-GO' || upperVal === 'SLOW' || upperVal === 'VULNERABLE' || upperVal === 'MANUAL' || upperVal === 'FATAL') {
                        type = 'badge';
                        badgeType = upperVal.toLowerCase().replace(/-/g, '');
                    } else if (value.includes('%')) {
                        type = 'progress';
                    }
                }

                sections.push({ label, value, type, badgeType });
            });

            return sections;
        }

        function addMessage(text, sender = 'user', agentType = null, debugData = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}`;
            
            if (sender === 'agent' && agentType) {
                messageEl.classList.add(agentType);
                
                const header = document.createElement('div');
                header.className = 'message-header';
                header.innerHTML = `
                    <span class="agent-icon">${agents[agentType]?.icon || 'ü§ñ'}</span>
                    <span>${agents[agentType]?.name || agentType}</span>
                `;
                messageEl.appendChild(header);
                
                const content = document.createElement('div');
                content.className = 'message-content';
                
                const sections = parseAgentResponse(text, agentType);
                
                sections.forEach(section => {
                    const sectionEl = document.createElement('div');
                    sectionEl.className = `content-section ${agentType}`;
                    
                    if (section.label) {
                        const labelEl = document.createElement('div');
                        labelEl.className = 'section-label';
                        labelEl.textContent = section.label;
                        sectionEl.appendChild(labelEl);
                    }
                    
                    const valueEl = document.createElement('div');
                    valueEl.className = 'section-value';
                    
                    if (section.type === 'badge' && section.badgeType) {
                        const badge = document.createElement('span');
                        badge.className = `badge ${section.badgeType}`;
                        badge.textContent = section.value;
                        valueEl.appendChild(badge);
                    } else if (section.type === 'progress') {
                        const percentMatch = section.value.match(/(\d+)%/);
                        const percent = percentMatch ? parseInt(percentMatch[1], 10) : 85;
                        
                        const progressBar = document.createElement('div');
                        progressBar.className = 'confidence-bar';
                        
                        const fill = document.createElement('div');
                        fill.className = 'confidence-fill';
                        fill.style.width = '0%';
                        progressBar.appendChild(fill);
                        
                        const percentText = document.createElement('div');
                        percentText.className = 'confidence-text';
                        percentText.textContent = section.value;
                        valueEl.appendChild(percentText);
                        
                        valueEl.appendChild(progressBar);
                        
                        
                        setTimeout(() => {
                            fill.style.width = `${percent}%`;
                        }, 100);
                    } else {
                        valueEl.textContent = section.value;
                    }
                    
                    sectionEl.appendChild(valueEl);
                    content.appendChild(sectionEl);
                });
                
                messageEl.appendChild(content);

                if (debugCheckbox.checked && debugData) {
                    const debugPanel = createDebugPanel(debugData);
                    messageEl.appendChild(debugPanel);
                }
            } else {
                messageEl.textContent = text;
            }
            
            const emptyState = chatArea.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            chatArea.appendChild(messageEl);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            if (sender === 'user') {
                chatHistory.push(`User: ${text}`);
            } else if (agentType) {
                chatHistory.push(`${agents[agentType]?.name || agentType}: ${text}`);
            }
        }

        function addSkeletonMessage() {
            const skeleton = document.createElement('div');
            skeleton.className = 'message agent';
            skeleton.innerHTML = `
                <div class="skeleton">
                    <div class="skeleton-line" style="width: 100%; height: 16px;"></div>
                </div>
                <div class="skeleton">
                    <div class="skeleton-line" style="width: 80%; height: 14px;"></div>
                </div>
                <div class="skeleton">
                    <div class="skeleton-line" style="width: 90%; height: 14px;"></div>
                </div>
            `;
            const emptyState = chatArea.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            chatArea.appendChild(skeleton);
            chatArea.scrollTop = chatArea.scrollHeight;
            return skeleton;
        }

        function removeSkeletonMessage(skeleton) {
            if (skeleton && skeleton.parentNode) {
                skeleton.remove();
            }
        }

        // ===== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô =====

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || isLoading) return;

            addMessage(text, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';
            sendBtn.disabled = true;

            isLoading = true;

            const activeAgentsArray = Array.from(selectedAgents);
            const skeleton = addSkeletonMessage();

            try {
                const response = await fetch('/api/board', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({
                        message: text,
                        active_agents: activeAgentsArray,
                        history: chatHistory.slice(-20),
                        mode: hasSummary ? 'followup' : 'initial',
                        debug: !!debugCheckbox.checked
                    })
                });

                removeSkeletonMessage(skeleton);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const json = await response.json();

                if (!json.agents || !Array.isArray(json.agents)) {
                    throw new Error('Invalid response format');
                }

                json.agents.forEach(reply => {
                    addMessage(reply.text, 'agent', reply.agent, reply);
                });

                if (!hasSummary) {
                    hasSummary = true;
                    summaryBtn.style.display = 'block';
                    lastRoundAgents = activeAgentsArray;
                }

            } catch (err) {
                removeSkeletonMessage(skeleton);
                console.error('Request failed:', err);
                addMessage('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'agent', 'summary');
            } finally {
                isLoading = false;
                sendBtn.disabled = !messageInput.value.trim();
            }
        }

        async function runSingleAgentTurn(agent) {
            if (isLoading) return;

            isLoading = true;
            sendBtn.disabled = true;

            const skeleton = addSkeletonMessage();

            try {
                const response = await fetch('/api/agent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({
                        agent: agent,
                        history: chatHistory.slice(-20),
                        debug: !!debugCheckbox.checked
                    })
                });

                removeSkeletonMessage(skeleton);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                addMessage(data.text, 'agent', agent, data);

            } catch (err) {
                removeSkeletonMessage(skeleton);
                console.error('Single agent request failed:', err);
                addMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –∞–≥–µ–Ω—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'agent', agent);
            } finally {
                isLoading = false;
                sendBtn.disabled = !messageInput.value.trim();
            }
        }

        init();
    </script>
</body>
</html>
