<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–≤–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤</title>
    <style>
        :root {
            --color-primary: #208090;
            --color-secondary: #f5f5f5;
            --color-text: #1f2121;
            --color-border: #ddd;
            --color-ceo: #1e3a5f;
            --color-cfo: #2d5a3d;
            --color-cpo: #5a3d2d;
            --color-marketing: #3d2d5a;
            --color-skeptic: #8b4513;
            --color-summary: #555555;
            
            /* Status colors */
            --color-success: #22c55e;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-info: #3b82f6;
        }
        
        html, body {
            height: 100%;
        }
        
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f9f9f9;
            color: var(--color-text);
        }

        .container {
            display: flex;
            min-height: calc(var(--vh, 1vh) * 100);
            height: calc(var(--vh, 1vh) * 100);
            gap: 0;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--color-border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 8px;
        }

        .agent-card {
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 200ms;
            font-size: 13px;
        }

        .agent-card:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .agent-card.ceo {
            border-left-color: var(--color-ceo);
            background: rgba(30, 58, 95, 0.08);
        }

        .agent-card.cfo {
            border-left-color: var(--color-cfo);
            background: rgba(45, 90, 61, 0.08);
        }

        .agent-card.cpo {
            border-left-color: var(--color-cpo);
            background: rgba(90, 61, 45, 0.08);
        }

        .agent-card.marketing {
            border-left-color: var(--color-marketing);
            background: rgba(61, 45, 90, 0.08);
        }

        .agent-card.skeptic {
            border-left-color: var(--color-skeptic);
            background: rgba(139, 69, 19, 0.08);
        }

        .agent-card.disabled {
            opacity: 0.6;
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agent-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .agent-status.on {
            background: #22c55e;
        }

        .agent-status.off {
            background: #9ca3af;
        }

        .agent-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .agent-role {
            font-size: 12px;
            color: #666;
        }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--color-border);
            background: white;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            padding: 16px;
            border-radius: 12px;
            max-width: clamp(280px, 80%, 700px);
            word-wrap: break-word;
            animation: slideIn 300ms ease-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            background: var(--color-primary);
            color: white;
            margin-right: 0;
        }

        .message.agent {
            align-self: flex-start;
            background: white;
            border: 1px solid var(--color-border);
            position: relative;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≥–µ–Ω—Ç–∞ —Å –∏–∫–æ–Ω–∫–æ–π */
        .message-header {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid;
        }

        .agent-icon {
            font-size: 18px;
            line-height: 1;
        }

        .message.agent.ceo .message-header { 
            color: var(--color-ceo); 
            border-bottom-color: var(--color-ceo);
        }
        .message.agent.cfo .message-header { 
            color: var(--color-cfo); 
            border-bottom-color: var(--color-cfo);
        }
        .message.agent.cpo .message-header { 
            color: var(--color-cpo); 
            border-bottom-color: var(--color-cpo);
        }
        .message.agent.marketing .message-header { 
            color: var(--color-marketing); 
            border-bottom-color: var(--color-marketing);
        }
        .message.agent.skeptic .message-header { 
            color: var(--color-skeptic); 
            border-bottom-color: var(--color-skeptic);
        }
        .message.agent.summary .message-header { 
            color: var(--color-summary); 
            border-bottom-color: var(--color-summary);
        }

        /* –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .message-content {
            font-size: 14px;
            line-height: 1.6;
        }

        .content-section {
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.02);
            border-radius: 6px;
            border-left: 3px solid;
        }

        .content-section.ceo { border-left-color: var(--color-ceo); }
        .content-section.cfo { border-left-color: var(--color-cfo); }
        .content-section.cpo { border-left-color: var(--color-cpo); }
        .content-section.marketing { border-left-color: var(--color-marketing); }
        .content-section.skeptic { border-left-color: var(--color-skeptic); }
        .content-section.summary { border-left-color: var(--color-summary); }

        .section-label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .section-value {
            font-size: 14px;
            color: var(--color-text);
            line-height: 1.5;
        }

        /* –ë–µ–π–¥–∂–∏ –¥–ª—è –≤–µ—Ä–¥–∏–∫—Ç–æ–≤ */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.success {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }

        .badge.danger {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        .badge.info {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è Confidence */
        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 6px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-success), var(--color-info));
            border-radius: 4px;
            transition: width 600ms ease-out;
        }

        .confidence-text {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-top: 4px;
        }

        /* Skeleton loader –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤ */
        .skeleton-message {
            align-self: flex-start;
            max-width: clamp(280px, 80%, 700px);
            padding: 16px;
            border-radius: 12px;
            background: white;
            border: 1px solid var(--color-border);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .skeleton-header {
            width: 120px;
            height: 20px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .skeleton-line {
            height: 12px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .skeleton-line.short {
            width: 60%;
        }

        .skeleton-line.medium {
            width: 80%;
        }

        .skeleton-line.long {
            width: 100%;
        }

        .input-area {
            padding: 20px 24px;
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: 12px;
            background: white;
            flex-shrink: 0;
            align-items: center;
            flex-wrap: wrap;
        }

        .summary-btn {
            padding: 12px 16px;
            background: #e5e7eb;
            color: #374151;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            flex-shrink: 0;
            margin-right: 8px;
            transition: all 200ms;
        }

        .summary-btn:hover {
            background: #d1d5db;
            transform: translateY(-1px);
        }

        .debug-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #666;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .debug-label input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .input-field {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(32, 128, 144, 0.1);
        }

        .send-btn {
            padding: 12px 24px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 200ms;
            height: 44px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            background: #1a6472;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(32, 128, 144, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 13px;
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ddd;
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            font-size: 16px;
            text-align: center;
            flex-direction: column;
            gap: 12px;
        }

        .empty-state-icon {
            font-size: 48px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: calc(var(--vh, 1vh) * 100);
                min-height: calc(var(--vh, 1vh) * 100);
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100%;
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 12px;
                gap: 8px;
                border-right: none;
                border-bottom: 1px solid var(--color-border);
                background: #fff;
                z-index: 10;
            }

            .sidebar-title {
                display: none;
            }

            .agent-card {
                min-width: 120px;
                flex-shrink: 0;
            }

            .main-area {
                margin-top: 72px;
            }

            .chat-area {
                padding: 12px;
            }

            .input-area {
                padding: 12px;
                flex-direction: column;
            }

            .message {
                max-width: 100%;
            }

            .input-field {
                min-width: auto;
                width: 100%;
            }

            .send-btn {
                width: 100%;
            }

            .summary-btn {
                width: 100%;
                margin-right: 0;
            }

            .debug-label {
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar with agents -->
        <div class="sidebar">
            <div class="sidebar-title">–°–æ–≤–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤</div>
            
            <div class="agent-card ceo" data-agent="ceo">
                <div class="agent-header">
                    <span class="agent-status on"></span>
                    <div>
                        <div class="agent-name">CEO</div>
                        <div class="agent-role">–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ –≤–∏–¥–µ–Ω–∏–µ</div>
                    </div>
                </div>
            </div>

            <div class="agent-card cfo" data-agent="cfo">
                <div class="agent-header">
                    <span class="agent-status on"></span>
                    <div>
                        <div class="agent-name">CFO</div>
                        <div class="agent-role">–§–∏–Ω–∞–Ω—Å—ã –∏ —Ä–∏—Å–∫–∏</div>
                    </div>
                </div>
            </div>

            <div class="agent-card cpo" data-agent="cpo">
                <div class="agent-header">
                    <span class="agent-status on"></span>
                    <div>
                        <div class="agent-name">CPO</div>
                        <div class="agent-role">–ü—Ä–æ–¥—É–∫—Ç –∏ UX</div>
                    </div>
                </div>
            </div>

            <div class="agent-card marketing" data-agent="marketing">
                <div class="agent-header">
                    <span class="agent-status on"></span>
                    <div>
                        <div class="agent-name">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
                        <div class="agent-role">–†—ã–Ω–æ–∫ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                    </div>
                </div>
            </div>

            <div class="agent-card skeptic" data-agent="skeptic">
                <div class="agent-header">
                    <span class="agent-status on"></span>
                    <div>
                        <div class="agent-name">–°–∫–µ–ø—Ç–∏–∫</div>
                        <div class="agent-role">–†–∏—Å–∫–∏ –∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main chat area -->
        <div class="main-area">
            <div class="header">
                <h1 class="header-title">–ó–∞—Å–µ–¥–∞–Ω–∏–µ —Å–æ–≤–µ—Ç–∞</h1>
            </div>

            <div class="chat-area" id="chatArea">
                <div class="empty-state">
                    <div class="empty-state-icon">üíº</div>
                    <div>–ù–∞—á–Ω–∏—Ç–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ ‚Äî –æ–ø–∏—à–∏—Ç–µ –∏–¥–µ—é –∏–ª–∏ –≤–æ–ø—Ä–æ—Å –¥–ª—è —Å–æ–≤–µ—Ç–∞</div>
                </div>
            </div>

            <div class="input-area">
                <button class="summary-btn" id="summaryBtn" style="display: none;">
                    –û–±–Ω–æ–≤–∏—Ç—å –∏—Ç–æ–≥–∏
                </button>

                <!-- –ß–ï–ö–ë–û–ö–° –î–õ–Ø DEBUG -->
                <label class="debug-label">
                    <input type="checkbox" id="debugCheckbox" />
                    <span>debug</span>
                </label>

                <textarea 
                    class="input-field" 
                    id="messageInput" 
                    placeholder="–û–ø–∏—à–∏—Ç–µ –∏–¥–µ—é, –∑–∞–¥–∞—á—É –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è..."
                    rows="1"
                ></textarea>
                <button class="send-btn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

<script>
    // —Ñ–∏–∫—Å 100vh –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö
    function setVh() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVh();
    window.addEventListener('resize', setVh);

    let authToken = null;

    function generateOrGetUserId() {
        let userId = localStorage.getItem("board_user_id");
        if (!userId) {
            userId = "user_" + Date.now() + "_" + Math.random().toString(36).slice(2, 8);
            localStorage.setItem("board_user_id", userId);
        }
        return userId;
    }

    async function initAuth() {
        const userId = generateOrGetUserId();

        try {
            const response = await fetch("/api/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ user_id: userId }),
            });

            if (!response.ok) {
                console.error("Auth failed:", response.status, response.statusText);
                return;
            }

            const data = await response.json();
            authToken = data.access_token;
            console.log("Auth OK for", userId);
        } catch (e) {
            console.error("Auth error:", e);
        }
    }

    window.addEventListener("load", initAuth);
    
    const agents = {
        ceo:       { name: 'CEO', role: '–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏ –≤–∏–¥–µ–Ω–∏–µ', icon: 'üéØ' },
        cfo:       { name: 'CFO', role: '–§–∏–Ω–∞–Ω—Å—ã –∏ —Ä–∏—Å–∫–∏', icon: 'üí∞' },
        cpo:       { name: 'CPO', role: '–ü—Ä–æ–¥—É–∫—Ç –∏ UX', icon: 'üîß' },
        marketing: { name: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥', role: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥', icon: 'üìà' },
        skeptic:   { name: '–°–∫–µ–ø—Ç–∏–∫', role: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç–Ω–∏–∫', icon: '‚ö†Ô∏è' },
        summary:   { name: '–ò—Ç–æ–≥–∏', role: '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏', icon: '‚úÖ' },
    };

    const ALL_AGENTS = ['ceo', 'cfo', 'cpo', 'marketing', 'skeptic'];

    let selectedAgents = new Set(ALL_AGENTS);
    let lastRoundAgents = [];
    let hasSummary = false;
    let chatHistory = [];

    const chatArea = document.getElementById('chatArea');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const summaryBtn = document.getElementById('summaryBtn');
    const debugCheckbox = document.getElementById('debugCheckbox');
    let isLoading = false;

    // –∞–≤—Ç–æ‚Äë—Ä–µ—Å–∞–π–∑ textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        
        // Disable send button if empty
        sendBtn.disabled = !this.value.trim();
    });

    // Initially disable send button
    sendBtn.disabled = true;

    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –∞–≥–µ–Ω—Ç–æ–≤
    setupAgentCards();

    // –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    summaryBtn.addEventListener('click', async () => {
        if (!hasSummary || isLoading) return;

        try {
            isLoading = true;
            sendBtn.disabled = true;
            summaryBtn.disabled = true;

            const url = "/api/summary";

            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${authToken}`,
                },
                body: JSON.stringify({
                    history: chatHistory.slice(-20),
                    debug: !!debugCheckbox.checked
                })
            });

            if (!response.ok) {
                const txt = await response.text().catch(() => "");
                console.error("Summary error:", response.status, response.statusText, txt);

                if (response.status === 429) {
                    addMessage('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∏—Ç–æ–≥–∞–º. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'agent', 'summary');
                } else {
                    addMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'agent', 'summary');
                }
                return;
            }

            const data = await response.json();
            addMessage(data.text, 'agent', 'summary');

        } catch (err) {
            console.error("Request failed:", err);
            addMessage('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ –∏—Ç–æ–≥–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'agent', 'summary');
        } finally {
            isLoading = false;
            sendBtn.disabled = !messageInput.value.trim();
            summaryBtn.disabled = false;
        }
    });

    function setupAgentCards() {
        document.querySelectorAll('.agent-card').forEach(card => {
            const agent = card.dataset.agent;

            card.addEventListener('click', () => {
                if (isLoading) return;

                const hasHistory = chatHistory.length > 0;

                if (!hasHistory || !hasSummary) {
                    if (selectedAgents.has(agent)) {
                        selectedAgents.delete(agent);
                        setAgentSelected(agent, false);
                    } else {
                        selectedAgents.add(agent);
                        setAgentSelected(agent, true);
                    }
                } else {
                    runSingleAgentTurn(agent);
                }
            });
        });

        selectedAgents.forEach(a => setAgentSelected(a, true));
    }

    function setAgentSelected(agent, isSelected) {
        const card = document.querySelector(`.agent-card[data-agent="${agent}"]`);
        if (!card) return;
        const dot = card.querySelector('.agent-status');
        if (!dot) return;
        if (isSelected) {
            dot.classList.add('on');
            dot.classList.remove('off');
        } else {
            dot.classList.add('off');
            dot.classList.remove('on');
        }
    }

    // –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∞–≥–µ–Ω—Ç–∞
    function parseAgentResponse(text, agentType) {
        const sections = [];
        const lines = text.split('\n').filter(l => l.trim());
        
        lines.forEach(line => {
            // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω [Label] ‚Äî value –∏–ª–∏ [Label]: value
            const match = line.match(/^\[([^\]]+)\]\s*[‚Äî:-]\s*(.+)$/);
            if (match) {
                const label = match[1].trim();
                const value = match[2].trim();
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–µ–∫—Ü–∏–∏
                let sectionType = 'text';
                let badgeType = null;
                
                const labelLower = label.toLowerCase();
                const valueLower = value.toLowerCase();
                
                if (labelLower.includes('verdict')) {
                    sectionType = 'badge';
                    if (valueLower.includes('go') && !valueLower.includes('no-go')) {
                        badgeType = 'success';
                    } else if (valueLower.includes('no-go')) {
                        badgeType = 'danger';
                    } else if (valueLower.includes('fast')) {
                        badgeType = 'success';
                    } else if (valueLower.includes('slow')) {
                        badgeType = 'warning';
                    } else if (valueLower.includes('safe')) {
                        badgeType = 'success';
                    } else if (valueLower.includes('vulnerable')) {
                        badgeType = 'danger';
                    } else if (valueLower.includes('scalable')) {
                        badgeType = 'info';
                    } else if (valueLower.includes('manual')) {
                        badgeType = 'warning';
                    } else if (valueLower.includes('fatal')) {
                        badgeType = 'danger';
                    } else if (valueLower.includes('fixable')) {
                        badgeType = 'warning';
                    }
                } else if (labelLower.includes('confidence')) {
                    sectionType = 'progress';
                }
                
                sections.push({ label, value, type: sectionType, badgeType });
            } else if (line.trim()) {
                // –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                sections.push({ label: null, value: line.trim(), type: 'text' });
            }
        });
        
        return sections.length > 0 ? sections : [{ label: null, value: text, type: 'text' }];
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –∞–≥–µ–Ω—Ç–∞
    function addMessage(text, sender = 'user', agentType = null) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${sender}`;
        
        if (sender === 'agent' && agentType) {
            messageEl.classList.add(agentType);
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.innerHTML = `
                <span class="agent-icon">${agents[agentType].icon}</span>
                <span>${agents[agentType].name}</span>
            `;
            messageEl.appendChild(header);
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const sections = parseAgentResponse(text, agentType);
            
            sections.forEach(section => {
                const sectionEl = document.createElement('div');
                sectionEl.className = `content-section ${agentType}`;
                
                if (section.label) {
                    const labelEl = document.createElement('div');
                    labelEl.className = 'section-label';
                    labelEl.textContent = section.label;
                    sectionEl.appendChild(labelEl);
                }
                
                const valueEl = document.createElement('div');
                valueEl.className = 'section-value';
                
                if (section.type === 'badge' && section.badgeType) {
                    const badge = document.createElement('span');
                    badge.className = `badge ${section.badgeType}`;
                    badge.textContent = section.value;
                    valueEl.appendChild(badge);
                } else if (section.type === 'progress') {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç
                    const percentMatch = section.value.match(/(\d+)%/);
                    const percent = percentMatch ? parseInt(percentMatch[1], 10) : 85;
                    
                    const progressBar = document.createElement('div');
                    progressBar.className = 'confidence-bar';
                    
                    const fill = document.createElement('div');
                    fill.className = 'confidence-fill';
                    fill.style.width = '0%';
                    progressBar.appendChild(fill);
                    
                    const percentText = document.createElement('div');
                    percentText.className = 'confidence-text';
                    percentText.textContent = section.value;
                    
                    valueEl.appendChild(progressBar);
                    valueEl.appendChild(percentText);
                    
                    // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                    setTimeout(() => {
                        fill.style.width = `${percent}%`;
                    }, 100);
                } else {
                    valueEl.textContent = section.value;
                }
                
                sectionEl.appendChild(valueEl);
                content.appendChild(sectionEl);
            });
            
            messageEl.appendChild(content);
        } else {
            messageEl.textContent = text;
        }
        
        // –£–¥–∞–ª—è–µ–º empty state –µ—Å–ª–∏ –µ—Å—Ç—å
        const emptyState = chatArea.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        chatArea.appendChild(messageEl);
        chatArea.scrollTop = chatArea.scrollHeight;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        if (sender === 'user') {
            chatHistory.push(`User: ${text}`);
        } else if (agentType) {
            chatHistory.push(`${agents[agentType].name}: ${text}`);
        }
    }

    // Skeleton loader –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function addSkeletonMessage() {
        const skeleton = document.createElement('div');
        skeleton.className = 'skeleton-message';
        skeleton.innerHTML = `
            <div class="skeleton-header"></div>
            <div class="skeleton-line long"></div>
            <div class="skeleton-line medium"></div>
            <div class="skeleton-line short"></div>
        `;
        
        const emptyState = chatArea.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        chatArea.appendChild(skeleton);
        chatArea.scrollTop = chatArea.scrollHeight;
        return skeleton;
    }

    function removeSkeletonMessage(skeleton) {
        if (skeleton && skeleton.parentNode) {
            skeleton.remove();
        }
    }

    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || isLoading) return;

        addMessage(text, 'user');
        messageInput.value = '';
        messageInput.style.height = 'auto';
        sendBtn.disabled = true;

        isLoading = true;

        const activeAgentsArray = Array.from(selectedAgents);
        const skeleton = addSkeletonMessage();

        try {
            const response = await fetch('/api/board', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                },
                body: JSON.stringify({
                    message: text,
                    active_agents: activeAgentsArray,
                    history: chatHistory.slice(-20),
                    mode: hasSummary ? 'followup' : 'initial',
                    debug: !!debugCheckbox.checked
                })
            });

            removeSkeletonMessage(skeleton);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const json = await response.json();

            // debug=false -> —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: –º–∞—Å—Å–∏–≤ AgentReply
            // debug=true  -> –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: { user_message_original, user_message_compressed, agents_replies: [...] }
            let replies;
            if (debugCheckbox.checked && json && json.agents_replies && Array.isArray(json.agents_replies)) {
                replies = json.agents_replies;
            } else if (Array.isArray(json)) {
                replies = json;
            } else {
                replies = [];
            }

            replies.forEach(reply => {
                addMessage(reply.text, 'agent', reply.agent);
            });

            if (!hasSummary) {
                hasSummary = true;
                summaryBtn.style.display = 'block';
                lastRoundAgents = activeAgentsArray;
            }

        } catch (err) {
            removeSkeletonMessage(skeleton);
            console.error('Request failed:', err);
            addMessage('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'agent', 'summary');
        } finally {
            isLoading = false;
            sendBtn.disabled = !messageInput.value.trim();
        }
    }

    async function runSingleAgentTurn(agent) {
        if (isLoading) return;

        isLoading = true;
        sendBtn.disabled = true;

        const skeleton = addSkeletonMessage();

        try {
            const response = await fetch('/api/agent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                },
                body: JSON.stringify({
                    agent: agent,
                    history: chatHistory.slice(-20),
                    debug: !!debugCheckbox.checked
                })
            });

            removeSkeletonMessage(skeleton);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            addMessage(data.text, 'agent', agent);

        } catch (err) {
            removeSkeletonMessage(skeleton);
            console.error('Single agent request failed:', err);
            addMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –∞–≥–µ–Ω—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'agent', agent);
        } finally {
            isLoading = false;
            sendBtn.disabled = !messageInput.value.trim();
        }
    }
</script>
</body>
</html>
